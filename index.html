<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Swachhify</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:Poppins,sans-serif;
  background:#B6D83D;
}

header{
  text-align:center;
  padding:20px;
  color:white;
}

.dashboard{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
  margin:20px;
}

.card{
  background:rgba(255,255,255,.7);
  padding:20px;
  border-radius:16px;
}

#map{height:320px;border-radius:12px}

.aqi{
  font-size:2rem;
  padding:10px;
  border-radius:12px;
  margin-top:10px;
  animation:pulse 2s infinite;
}

.good{background:#7ed957}
.moderate{background:#ffd93d}
.poor{background:#ff6b6b}

@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(0,0,0,.3)}
  70%{box-shadow:0 0 0 14px rgba(0,0,0,0)}
}

@media(max-width:768px){
  .dashboard{grid-template-columns:1fr}
}
</style>
</head>

<body>

<header>
  <h1>Swachhify</h1>
  <p>SENSE MORE · LIVE BETTER</p>
</header>

<div class="dashboard">

<div class="card">
  <p><b>Location:</b> <span id="loc">Loading…</span></p>
  <p><b>Light Pollution:</b> <span id="light">Calculating…</span></p>
  <div id="aqiBox" class="aqi">AQI: --</div>
</div>

<div class="card">
  <div id="map"></div>
</div>

</div>

<div class="card" style="margin:20px">
  <h3>Noise Level</h3>
  <p id="noise">Idle</p>
  <button onclick="startNoise()">Start Mic</button>
</div>

<script>
/* -------- MAP & LOCATION -------- */
navigator.geolocation.getCurrentPosition(pos=>{
  const lat=pos.coords.latitude;
  const lon=pos.coords.longitude;

  document.getElementById("loc").innerText =
    lat.toFixed(3)+", "+lon.toFixed(3);

  document.getElementById("light").innerText =
    lat>60 ? "Low (Bortle 3)" : "Moderate (Bortle 6)";

  const map=L.map("map").setView([lat,lon],9);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  L.marker([lat,lon]).addTo(map);
});

/* -------- AQI FROM ESP32 (ThingSpeak) -------- */
const CHANNEL_ID = "YOUR_CHANNEL_ID";
const READ_KEY = "YOUR_READ_API_KEY";

async function fetchAQI(){
  const url =
    `https://api.thingspeak.com/channels/${CHANNEL_ID}/fields/1.json?api_key=${READ_KEY}&results=1`;
  const res = await fetch(url);
  const data = await res.json();
  const aqi = parseInt(data.feeds[0].field1);

  const box=document.getElementById("aqiBox");
  box.innerText="AQI: "+aqi;
  box.className="aqi";

  if(aqi<=50) box.classList.add("good");
  else if(aqi<=100) box.classList.add("moderate");
  else box.classList.add("poor");
}

setInterval(fetchAQI,5000);
fetchAQI();

/* -------- NOISE -------- */
async function startNoise(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    const ctx=new AudioContext();
    const analyser=ctx.createAnalyser();
    ctx.createMediaStreamSource(stream).connect(analyser);
    const data=new Uint8Array(analyser.frequencyBinCount);

    function loop(){
      analyser.getByteFrequencyData(data);
      let avg=data.reduce((a,b)=>a+b,0)/data.length;
      document.getElementById("noise").innerText =
        Math.round(avg/255*100)+" dB";
      requestAnimationFrame(loop);
    }
    loop();
  }catch{
    document.getElementById("noise").innerText="Permission blocked";
  }
}
</script>

</body>
</html>
